# Network Policy para Integration Gateway
#
# Esta policy implementa o princípio de menor privilégio (least privilege)
# permitindo apenas tráfego necessário para operação do Integration Gateway.
#
# Segurança:
#   - Ingress: Apenas de bgc-api e prometheus
#   - Egress: DNS, Redis, PostgreSQL, APIs externas HTTPS, Jaeger

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: integration-gateway-netpol
  namespace: data
  labels:
    app: integration-gateway
    component: network-security
  annotations:
    description: "Network policy for Integration Gateway - restricts traffic to essential services only"
    owner: "security-team"
    last-reviewed: "2025-11-19"
spec:
  podSelector:
    matchLabels:
      app: integration-gateway

  policyTypes:
  - Ingress
  - Egress

  # ============================================================================
  # INGRESS RULES - Quem pode acessar o Integration Gateway
  # ============================================================================
  ingress:

  # Regra 1: API Principal (bgc-api) pode acessar gateway na porta 8081
  - from:
    - podSelector:
        matchLabels:
          app: bgc-api
    ports:
    - protocol: TCP
      port: 8081
      name: http

  # Regra 2: Prometheus pode scrape métricas na porta 9090
  - from:
    - namespaceSelector:
        matchLabels:
          name: observability
      podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090
      name: metrics

  # Regra 3: Health checks do Kubernetes (kubelet)
  # Permite probes (liveness, readiness)
  - from:
    - namespaceSelector: {}
      podSelector: {}
    ports:
    - protocol: TCP
      port: 8081
    # Limita a apenas endpoints de health
    # (implementado no código: /health, /ready)

  # ============================================================================
  # EGRESS RULES - Para onde o Integration Gateway pode se conectar
  # ============================================================================
  egress:

  # Regra 1: DNS (CoreDNS no kube-system)
  # Necessário para resolver nomes de domínio
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
      name: dns-udp
    - protocol: TCP
      port: 53
      name: dns-tcp

  # Regra 2: Redis (mesmo namespace)
  # Necessário para cache L2
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
      name: redis

  # Regra 3: PostgreSQL (mesmo namespace)
  # Necessário para cache L3 (materialized views)
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
      name: postgresql

  # Regra 4: APIs externas HTTPS (porta 443)
  # Permite acesso a ComexStat, ViaCEP, Receita Federal, etc.
  # IMPORTANTE: Não restringimos IPs para permitir flexibilidade
  # mas logs e observabilidade devem ser monitorados
  - to:
    - namespaceSelector: {}
      podSelector: {}
    ports:
    - protocol: TCP
      port: 443
      name: https

  # Regra 5: Jaeger (OpenTelemetry tracing)
  # Envia traces para o coletor Jaeger
  - to:
    - namespaceSelector:
        matchLabels:
          name: observability
      podSelector:
        matchLabels:
          app: jaeger
    ports:
    - protocol: TCP
      port: 4317
      name: otlp-grpc
    - protocol: TCP
      port: 4318
      name: otlp-http

  # Regra 6: Kubernetes API Server (para KubernetesSecretStore)
  # Necessário para buscar secrets via client-go
  - to:
    - namespaceSelector:
        matchLabels:
          name: default
      podSelector:
        matchLabels:
          component: apiserver
    ports:
    - protocol: TCP
      port: 443
      name: k8s-api

---

# Network Policy para Redis (garante que apenas Integration Gateway acessa)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-netpol
  namespace: data
  labels:
    app: redis
    component: network-security
  annotations:
    description: "Network policy for Redis - allows only Integration Gateway and API"
spec:
  podSelector:
    matchLabels:
      app: redis

  policyTypes:
  - Ingress

  ingress:
  # Permite apenas Integration Gateway e bgc-api
  - from:
    - podSelector:
        matchLabels:
          app: integration-gateway
    - podSelector:
        matchLabels:
          app: bgc-api
    ports:
    - protocol: TCP
      port: 6379

---

# Network Policy para PostgreSQL (garante isolamento)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-netpol
  namespace: data
  labels:
    app: postgres
    component: network-security
  annotations:
    description: "Network policy for PostgreSQL - allows only bgc-api and integration-gateway"
spec:
  podSelector:
    matchLabels:
      app: postgres

  policyTypes:
  - Ingress

  ingress:
  # Permite apenas Integration Gateway e bgc-api
  - from:
    - podSelector:
        matchLabels:
          app: integration-gateway
    - podSelector:
        matchLabels:
          app: bgc-api
    ports:
    - protocol: TCP
      port: 5432
