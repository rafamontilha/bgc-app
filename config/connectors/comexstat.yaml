# Connector: ComexStat - API de Dados de Com√©rcio Exterior
# Fornece dados de exporta√ß√£o e importa√ß√£o do Brasil
# üî• CACHE MULTIN√çVEL HABILITADO (L1+L2+L3)

id: comexstat
name: ComexStat - Com√©rcio Exterior Brasil
version: 1.0.0
provider: MDIC - Minist√©rio do Desenvolvimento, Ind√∫stria e Com√©rcio

integration:
  type: rest_api
  protocol: https

  # Autentica√ß√£o via API Key (via Sealed Secret)
  auth:
    type: api_key
    api_key:
      header_name: X-API-Key
      key_ref: comexstat-credentials/api-key  # K8s Secret

  endpoints:
    # Exporta√ß√£o por m√™s
    exportacao_mes:
      method: POST
      path: /api/exp/{ano}/{mes}
      timeout: 30s

      headers:
        Accept: application/json
        Content-Type: application/json

      path_params:
        - name: ano
          type: integer
          required: true
          pattern: "^(2020|2021|2022|2023|2024|2025)$"
        - name: mes
          type: integer
          required: true
          pattern: "^(0?[1-9]|1[0-2])$"

      body:
        content_type: application/json
        template: |
          {
            "co_ano": {{ano}},
            "co_mes": {{mes}},
            "no_pais_destino": null,
            "co_ncm": null
          }

      response:
        success_status: [200]
        error_status: [400, 401, 403, 404, 429, 500]

        # Mapeamento de campos
        mapping:
          data: $.data
          total_records: $.total
          page: $.page

    # Importa√ß√£o por m√™s
    importacao_mes:
      method: POST
      path: /api/imp/{ano}/{mes}
      timeout: 30s

      headers:
        Accept: application/json
        Content-Type: application/json

      path_params:
        - name: ano
          type: integer
          required: true
        - name: mes
          type: integer
          required: true

      body:
        content_type: application/json
        template: |
          {
            "co_ano": {{ano}},
            "co_mes": {{mes}},
            "no_pais_origem": null,
            "co_ncm": null
          }

      response:
        success_status: [200]
        error_status: [400, 401, 403, 404, 429, 500]

        mapping:
          data: $.data
          total_records: $.total
          page: $.page

  # Resili√™ncia - CRITICAL (ComexStat tem rate limit r√≠gido)
  resilience:
    retry:
      max_attempts: 3
      backoff: exponential
      initial_interval: 2s
      max_interval: 10s

    circuit_breaker:
      failure_threshold: 3
      success_threshold: 2
      timeout: 2m  # 2 minutos de espera ap√≥s abrir

    rate_limit:
      requests_per_minute: 4  # Margem de seguran√ßa (limite real: 300/hora = 5/min)
      burst: 2

  # üî• Cache MULTIN√çVEL - M√ÅXIMA AGRESSIVIDADE
  # Meta: Hit rate 98% | Reduzir 1000 req/dia ‚Üí 20 req/dia
  cache:
    enabled: true
    # TTL diferenciado:
    # - Dados hist√≥ricos (ano < atual): 7 dias (dados n√£o mudam)
    # - M√™s atual: 6h (dados podem ser atualizados)
    # - Implementar l√≥gica din√¢mica no c√≥digo
    ttl: 168h  # 7 dias (padr√£o para hist√≥rico)
    key_pattern: "comexstat:exp:{ano}:{mes}:{ncm}:{pais}"

# Ambientes
environments:
  development:
    base_url: https://api.comexstat.mdic.gov.br
    health_check: /api/health

  production:
    base_url: https://api.comexstat.mdic.gov.br
    health_check: /api/health

# Compliance - Dados P√öBLICOS mas com restri√ß√µes de uso
compliance:
  tags:
    - MDIC
    - Dados-Publicos
    - Comercio-Exterior
  data_classification: public
  retention_days: 365  # 1 ano de hist√≥rico em cache
  encryption_required: false

# Governan√ßa
governance:
  owner_team: data-team
  approved_by: tech-lead
  last_audited: 2025-01-21
  review_frequency: quarterly

# Observabilidade
observability:
  metrics_enabled: true
  tracing_enabled: true
  log_level: info

  # Alertas espec√≠ficos
  alerts:
    - type: error_rate
      threshold: "5%"
      window: 5m
      channels: [slack-data-team, pagerduty]

    - type: latency
      threshold: "5s"
      window: 5m
      channels: [slack-data-team]

    - type: availability
      threshold: "95%"
      window: 10m
      channels: [slack-data-team, pagerduty]

# üìù NOTAS DE IMPLEMENTA√á√ÉO
#
# Cache Strategy:
# - L1 (Ristretto): 100MB, LFU eviction, TTL 5min
# - L2 (Redis): Compartilhado entre pods, TTL 7 dias (hist√≥rico) | 6h (m√™s atual)
# - L3 (PostgreSQL): Materialized view `mv_comexstat_top_destinations`
# - Request Coalescing: Agrupa requests id√™nticas em 10s window
#
# Rate Limiting:
# - ComexStat: 300 req/hour (oficial)
# - Nossa config: 4 req/min com burst 2 (margem de seguran√ßa)
# - Com cache 98%, esperamos < 20 req/dia ao ComexStat
#
# TTL Din√¢mico (implementar no c√≥digo):
# - Se ano < ano_atual: TTL = 7 dias (dados hist√≥ricos imut√°veis)
# - Se ano == ano_atual E mes < mes_atual: TTL = 24h
# - Se ano == ano_atual E mes == mes_atual: TTL = 6h (dados podem mudar)
